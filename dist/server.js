!function(e){var n={};function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(n){return e[n]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="/",t(t.s=12)}([function(e,n){e.exports=require("passport")},function(e,n){e.exports=require("mongoose")},function(e,n){e.exports=require("bcryptjs")},function(e,n){e.exports=require("fs")},function(e,n){e.exports=require("jsonwebtoken")},function(e,n){e.exports=require("path")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("moment")},function(e,n){e.exports=require("morgan")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("cors")},function(e,n){e.exports=require("passport-local")},function(e,n,t){"use strict";t.r(n);var r=t(6),o=t.n(r),s=t(1),i=t.n(s),u=t(8),a=t.n(u),c=t(0),l=t.n(c),d=t(9),f=t.n(d),p=t(10),g=t.n(p),y=t(11),v=t(7),h=t.n(v);function b(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var m=new(function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.reflections=[]}var n,t,r;return n=e,(t=[{key:"create",value:function(e){var n={id:"1",success:e.success||"",lowPoint:e.lowPoint||"",takeAway:e.takeAway||"",createDate:h.a.now(),modifiedDate:h.a.now()};return this.reflections.push(n),n}},{key:"findAll",value:function(){return this.reflections}},{key:"findOne",value:function(e){return this.reflections.find(function(n){return n.id==e})}},{key:"delete",value:function(e){var n=this.findOne(e),t=this.reflections.indexOf(n);return this.reflections.splice(t,1),{}}}])&&b(n.prototype,t),r&&b(n,r),e}()),w={create:function(e,n){if(!e.body.success&&!e.body.lowPoint&&!e.body.takeAway)return n.status(400).send({message:"All fields are required"});var t=m.create(e.body);return n.status(201).send(t)},getAll:function(e,n){var t=m.findAll();return n.status(200).send(t)},getOne:function(e,n){console.log(e.params);var t=m.findOne(parseInt(e.params.id));return t?n.status(200).send(t):n.status(404).send({message:"Reflection not found"})},delete:function(e,n){if(!m.findOne(e.params.id))return n.status(400).send({message:"reflection not found"});var t=m.delete(e.params.id);return n.status(204).send(t)}},x=new s.Schema({username:{type:String,required:"Username is required",unique:!0},email:{type:String,required:"Email is required",lowercase:!0,unique:!0},password:{type:String,trim:!0}}),O=i.a.model("user",x),S=t(2),j={create:function(e,n){var t=new O(e.body);t.password=Object(S.hashSync)(e.body.password,10),t.save().then(function(e){return n.send(e)},function(e){return n.status(500).send(e)})},getAll:function(e,n){try{O.find().exec().then(function(e){return n.send(e)})}catch(e){n.status(500).send(e)}},getById:function(e,n){O.findById(e.params.id).exec().then(function(e){return n.send(e)},function(e){return n.status(500).send(e)})},getUserById:function(e,n){console.log("getting user by id"),O.findById(e).exec().then(function(e){var t=e[0];return t.password=void 0,n(null,t)},function(e){return n(e,null)})},authenticateUser:function(e,n,t){O.find({username:e}).exec().then(function(e){if(e.length>0&&Object(S.compareSync)(n,e[0].password)){var r=e[0];return r.password=void 0,t(null,r)}return t("invalid username or password",null)},function(e){return t("unknown error",null)})}},q=t(3),k=t(4),P=t(5),U=t.n(P),A={authenticate:function(e,n){O.find({username:e.body.username}).exec().then(function(t){if(t.length>0&&Object(S.compareSync)(e.body.password,t[0].password)){var r=t[0];r.password=void 0;var o={issuer:"Nabil Corp",subject:r.email,audience:"localhost",expiresIn:"3600000",algorithm:"RS512"},s=U.a.resolve("./src/keys/private.key"),i=Object(q.readFileSync)(s,"utf-8"),u=Object(k.sign)(r.toJSON(),i,o);n.send(u)}else n.send({error:"Invalid credentials"})},function(e){return n.send({error:"Technical error"})})},test:function(e,n){var t=e.headers.authorization;if(null!=t){var r=U.a.resolve("./src/keys/public.key"),o=Object(q.readFileSync)(r,"utf-8"),s=t.split(" ")[1];Object(k.verify)(s,o,function(e,t){e?(console.log(e),n.status(403).send("Unauthorized")):n.send(t)})}else n.status(403).send("Unauthorized")}},I=function(e,n,t){if(console.log(e.connection.remoteAddress),console.log(e.url),console.log(e.session),console.log(e.user),e.headers["user-agent"]){var r=e.headers["user-agent"];return console.log(r),r.includes("Trident")||r.includes("Postman")||e.headers["postman-token"]?n.status(404).send():t()}return n.status(401).send()},z=function(e,n,t){var r=e.headers.authorization;if(null!=r){var o=U.a.resolve("./src/keys/public.key"),s=Object(q.readFileSync)(o,"utf-8"),i=r.split(" ")[1];Object(k.verify)(i,s,function(e,r){e?(console.log(e),n.status(403).send("Unauthorized")):t()})}else n.status(403).send("Unauthorized")},B=o()(),T=process.env.PORT||3e3;i.a.connect("mongodb://localhost/users",{useNewUrlParser:!0}).then(function(){return console.log("Connected to MongoDB !")}).catch(function(e){return console.log(e)}),i.a.set("useCreateIndex",!0);B.use(g()({origin:"http://localhost:8080",optionsSuccessStatus:200})),B.use(o.a.json()),B.use(f.a.urlencoded({extended:!1})),B.use(a()("dev")),B.use(l.a.initialize()),B.use(l.a.session()),l.a.use("local",new y.Strategy(function(e,n,t){j.authenticateUser(e,n,function(e,n){return e?t(e):t(null,n)})})),l.a.serializeUser(function(e,n){n(null,e.id)}),l.a.deserializeUser(function(e,n){j.getUserById(e,function(e,t){return n(e,t)})}),B.post("/login",l.a.authenticate("local"),function(e,n){console.log("CONNECTE : "+e.user),e.logIn(e.user,function(e){return e&&console.log("ERROR Login: "+e),n.redirect("/api/v1/users")})}),B.get("/",function(e,n){return n.status(200).send({message:"Hello world from Express JS blah !"})}),B.post("/api/v1/reflections",[I,w.create]),B.get("/api/v1/reflections",[I,w.getAll]),B.get("/api/v1/reflections/:id",[I,w.getOne]),B.delete("/api/v1/reflections/:id",[I,I]),B.get("/api/v1/users",[z,j.getAll]),B.get("/api/v1/users/:id",j.getById),B.post("/api/v1/users",j.create),B.post("/api/auth",A.authenticate),B.get("/api/auth",A.test),B.listen(T,function(){console.log("Server running on port ".concat(T))})}]);