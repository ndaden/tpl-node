!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=11)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cors")},function(e,t,n){"use strict";n.r(t);var o=n(7),r=n.n(o),s=n(0),a=n.n(s),i=n(8),c=n.n(i),u=n(9),d=n.n(u),l=n(10),f=n.n(l),p=n(1),v=n.n(p);function m(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var g=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.reflections=[]}var t,n,o;return t=e,(n=[{key:"create",value:function(e){var t={id:"1",success:e.success||"",lowPoint:e.lowPoint||"",takeAway:e.takeAway||"",createDate:v.a.now(),modifiedDate:v.a.now()};return this.reflections.push(t),t}},{key:"findAll",value:function(){return this.reflections}},{key:"findOne",value:function(e){return this.reflections.find(function(t){return t.id==e})}},{key:"delete",value:function(e){var t=this.findOne(e),n=this.reflections.indexOf(t);return this.reflections.splice(n,1),{}}}])&&m(t.prototype,n),o&&m(t,o),e}()),h={create:function(e,t){if(!e.body.success&&!e.body.lowPoint&&!e.body.takeAway)return t.status(400).send({message:"All fields are required"});var n=g.create(e.body);return t.status(201).send(n)},getAll:function(e,t){var n=g.findAll();return t.status(200).send(n)},getOne:function(e,t){console.log(e.params);var n=g.findOne(parseInt(e.params.id));return n?t.status(200).send(n):t.status(404).send({message:"Reflection not found"})},delete:function(e,t){if(!g.findOne(e.params.id))return t.status(400).send({message:"reflection not found"});var n=g.delete(e.params.id);return t.status(204).send(n)}},y=new s.Schema({username:{type:String,required:"Username is required",unique:!0},email:{type:String,required:"Email is required",lowercase:!0,unique:!0},password:{type:String,trim:!0},isActive:{type:Boolean,default:!1},activationDate:{type:Date},activationCode:{type:a.a.Schema.Types.ObjectId,ref:"activationCode"}}),b=a.a.model("user",y),x=new s.Schema({validationCode:{type:String,maxlength:6,trim:!0},validationCodeSendDate:{type:Date},validationCodeExpirationDate:{type:Date}}),O=a.a.model("activationCode",x),A=n(6),w=n.n(A),I=process.env.MAILING_HOST||"smtp.mailgun.org",S=process.env.MAILING_PORT||587,j=process.env.MAILING_USERNAME||"postmaster@sandboxd8523e3764c14042b39a0c2b18bb41f2.mailgun.org",M=process.env.MAILING_PASSWORD||"0dfde859f5f38ff15aad253160c680a4-e470a504-609acc65",E=process.env.MAILING_SENDER_NAME||"React App v1.0",P=(process.env.MAILING_BASE_URL,process.env.MAILING_API_KEY,process.env.MAILING_TEST_MODE||!0);function C(e,t,n,o,r,s,a){try{var i=e[s](a),c=i.value}catch(e){return void n(e)}i.done?t(c):Promise.resolve(c).then(o,r)}var N=function(){var e,t=(e=regeneratorRuntime.mark(function e(t,n){var o,r,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=w.a.createTransport({host:I,port:S,secure:!1,auth:{user:j,pass:M}}),!P){e.next=9;break}return e.next=4,w.a.createTestAccount();case 4:r=e.sent,o=w.a.createTransport({host:"smtp.ethereal.email",port:587,secure:!1,auth:{user:r.user,pass:r.pass}}),console.log("using test mode"),console.log("user: %s",r.user),console.log("pass : %s",r.pass);case 9:return e.next=11,o.sendMail({from:"".concat(E," <").concat(j,">"),to:t,subject:"Activate your account !",text:"Your activation code is : "+n,html:"<center><h1>Activate your account</h1><p>"+n+"</p></center>"});case 11:s=e.sent,P&&console.log("Email envoyé. URL = %s",w.a.getTestMessageUrl(s));case 13:case"end":return e.stop()}},e)}),function(){var t=this,n=arguments;return new Promise(function(o,r){var s=e.apply(t,n);function a(e){C(s,o,r,a,i,"next",e)}function i(e){C(s,o,r,a,i,"throw",e)}a(void 0)})});return function(e,n){return t.apply(this,arguments)}}(),U=n(2),_={create:function(e,t){var n=k(6),o=new a.a.Types.ObjectId,r=new b(e.body);r.isActive=!1,r.activationCode=o,r.password=Object(U.hashSync)(e.body.password,10),r.save().then(function(e){new O({_id:o,validationCode:n,validationCodeSendDate:v()(),validationCodeExpirationDate:v()().add(30,"minute")}).save();var r={success:!0,user:{username:e.username,email:e.email},message:"Félicitations ! votre compte a été créé avec succés. Un code d'activation vous a été envoyé sur : "+e.email};N(e.email,n).then(function(){t.send(r)}).catch(function(e){r.success=!1,r.message="Un problème est survenu lors de l'envoi de votre code d'activation.",console.log(e),t.send(r)})}).catch(function(e){var n={success:!1,message:"Une erreur technique s'est produite. merci de contacter l'administrateur du site."};e.name&&"MongoError"==e.name&&11e3==e.code&&(n.message="Un compte avec le même e-mail ou nom d'utilisateur existe déjà."),t.status(500).send(n)})},activate:function(e,t){console.log(e.body);var n=e.body.activationCode,o=e.body.email;b.find({email:o}).exec().then(function(e){var o=e[0],r=o.activationCode;o.isActive?t.status(500).send({message:"Impossible d'effectuer cette action"}):O.findById(r).exec().then(function(e){e.validationCode===n&&v()().isBefore(e.validationCodeExpirationDate)?(o.isActive=!0,o.activationDate=v()(),o.activationCode=null,o.save(),e.remove(),t.send({message:"Votre compte a été activé avec succés !"})):t.send({message:"Code incorrect ou expiré"})})}).catch(function(e){console.log(e),t.status(500).send({message:"Impossible d'effectuer cette action"})})},getAll:function(e,t){try{b.find().exec().then(function(e){return t.send(e)})}catch(e){t.status(500).send(e)}},getById:function(e,t){b.findById(e.params.id).exec().then(function(e){return t.send(e)},function(e){return t.status(500).send(e)})},getUserById:function(e,t){console.log("getting user by id"),b.findById(e).exec().then(function(e){var n=e[0];return n.password=void 0,t(null,n)},function(e){return t(e,null)})},authenticateUser:function(e,t,n){b.find({username:e}).exec().then(function(e){if(e.length>0&&Object(U.compareSync)(t,e[0].password)){var o=e[0];return o.password=void 0,n(null,o)}return n("invalid username or password",null)},function(e){return n("unknown error",null)})}},k=function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXY1234567890",o=0;o<e;o++)t="".concat(t).concat(n.substr(Math.random()*n.length,1));return t},q=_,D=n(3),T=n(4),R=n(5),B=n.n(R),G={authenticate:function(e,t){b.find({username:e.body.username}).exec().then(function(n){if(n.length>0&&Object(U.compareSync)(e.body.password,n[0].password)){var o=n[0];o.password=void 0;var r={issuer:"Nabil Corp",subject:o.email,audience:"localhost",expiresIn:"3600000",algorithm:"RS512"},s=B.a.resolve("./src/keys/private.key"),a=process.env.PRIVATE_KEY||Object(D.readFileSync)(s,"utf-8"),i={success:!0,token:Object(T.sign)(o.toJSON(),a,r),message:"Vous êtes connectés",redirect:e.query.redirect};t.send(i)}else t.send({success:!1,message:"Nom d'utilisateur et/ou mot de passe invalide(s)"})},function(e){return t.send({success:!1,message:"Technical error"})})},test:function(e,t){var n=e.headers.authorization;if(null!=n){var o=B.a.resolve("./src/keys/public.key"),r=process.env.PUBLIC_KEY||Object(D.readFileSync)(o,"utf-8"),s=n.split(" ")[1];Object(T.verify)(s,r,function(e,n){e?(console.log(e),t.send({isAuthenticated:!1,data:"Unauthorized"})):t.send({isAuthenticated:!0,data:n})})}else t.send({isAuthenticated:!1,data:"Unauthorized"})}},L=function(e,t,n){if(console.log(e.connection.remoteAddress),console.log(e.url),console.log(e.session),console.log(e.user),e.headers["user-agent"]){var o=e.headers["user-agent"];return console.log(o),o.includes("Trident")||o.includes("Postman")||e.headers["postman-token"]?t.status(404).send():n()}return t.status(401).send()},z=function(e,t,n){var o=e.headers.authorization;if(null!=o){var r=B.a.resolve("./src/keys/public.key"),s=Object(D.readFileSync)(r,"utf-8"),a=o.split(" ")[1];Object(T.verify)(a,s,function(e,o){e?(console.log(e),t.status(403).send("Unauthorized")):n()})}else t.status(403).send("Unauthorized")},F=r()(),Y=process.env.PORT||3e3,K=process.env.MONGOUSER||"",V=process.env.MONGOPWD||"",W=process.env.MONGOURI||"localhost",H=process.env.MONGODBNAME||"users",J=process.env.FRONTAPPURI||"http://localhost:8080",Q="";Q=K&&V?"mongodb+srv://".concat(K,":").concat(V,"@").concat(W,"/").concat(H,"?retryWrites=true&w=majority"):"mongodb://".concat(W,"/").concat(H),a.a.connect(Q,{useNewUrlParser:!0}).then(function(){return console.log("Connected to MongoDB !")}).catch(function(e){return console.log(e)}),a.a.set("useCreateIndex",!0);var X={origin:J,optionsSuccessStatus:200};F.use(f()(X)),F.use(r.a.json()),F.use(d.a.urlencoded({extended:!1})),F.use(c()("dev")),F.get("/",function(e,t){return t.status(200).send({message:"Hello world from Express JS blah !"})}),F.post("/api/v1/reflections",[L,h.create]),F.get("/api/v1/reflections",[L,h.getAll]),F.get("/api/v1/reflections/:id",[L,h.getOne]),F.delete("/api/v1/reflections/:id",[L,L]),F.get("/api/v1/users",[z,q.getAll]),F.get("/api/v1/users/:id",q.getById),F.post("/api/v1/users",q.create),F.post("/api/v1/users/activate",q.activate),F.post("/api/auth",G.authenticate),F.get("/api/auth",G.test),F.listen(Y,function(){console.log("Server running on port ".concat(Y))})}]);